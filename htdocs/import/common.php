<?php

$_attributeIds = array(
    "age"   => 147,
    "size"  => 134,
    "shoe_size"  => 128
);

$_attributeSetMap = array(
    "1"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Trousers
    "2"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Tops
    "3"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Jackets
    "4"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Dresses
    "5"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Bottoms
    "6"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Sets / Suits
    "7"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Skirts
    "8"  => array("attribute_set" => "9", "configurable_attribute" => "age"), // Rompers / Sets
    "9"  => array("attribute_set" => "10", "configurable_attribute" => "shoe_size"), // Pre-walker
    "10" => array("attribute_set" => "10", "configurable_attribute" => "shoe_size"), // Shoes
    "11" => array("attribute_set" => "10", "configurable_attribute" => "shoe_size"), // Sandals  => Shoes
    "12" => array("attribute_set" => "10", "configurable_attribute" => "shoe_size"), // Trainers => Shoes
    "13" => array("attribute_set" => "10", "configurable_attribute" => "shoe_size"), // Boots    => Shoes
    "14" => array("attribute_set" => "11"),
);

$_brandAttributeMap = array(
    190 => array("brand" => 82, "top_category" => 10),
    //191 => array("brand" => 156, "top_category" => 10),
    194 => array("brand" => 73),
    135 => array("brand" => 142, "top_category" => 10),
    222 => array("brand" => 132, "top_category" => 33),
    126 => array("brand" => 155, "top_category" => 10),
    182 => array("brand" => 71, "top_category" => 9),
    186 => array("brand" => 101, "top_category" => 8),
    11 => array("brand" => 108, "top_category" => 9),
    12 => array("brand" => 79, "top_category" => 9),
    203 => array("brand" => 124, "top_category" => 33),
    240 => array("brand" => null),
    40 => array("brand" => 105, "top_category" => 10),
    17 => array("brand" => 96, "top_category" => 9),
    //18 => array("brand" => 106, "top_category" => 8),
    19 => array("brand" => 61, "top_category" => 8),
    76 => array("brand" => 107, "top_category" => 8),
    132 => array("brand" => 82, "top_category" => 9),
    49 => array("brand" => 99),
    23 => array("brand" => 105, "top_category" => 8),
    24 => array("brand" => 93, "top_category" => 8),
    25 => array("brand" => 110, "top_category" => 8),
    26 => array("brand" => 103, "top_category" => 8),
    48 => array("brand" => 99, "top_category" => 8),
    145 => array("brand" => 156, "top_category" => 9),
    31 => array("brand" => 98, "top_category" => 8),
    32 => array("brand" => 104, "top_category" => 8),
    187 => array("brand" => 79, "top_category" => 33),
    188 => array("brand" => 73, "top_category" => 9),
    35 => array("brand" => 92, "top_category" => 92),
    225 => array("brand" => 150, "top_category" => 150),
    37 => array("brand" => 134, "top_category" => 134),
    42 => array("brand" => 88, "top_category" => 88),
    46 => array("brand" => 145, "top_category" => 145),
    47 => array("brand" => 99, "top_category" => 99),
    50 => array("brand" => null),
    51 => array("brand" => 108, "top_category" => 8),
    52 => array("brand" => 90, "top_category" => 9),
    53 => array("brand" => 113, "top_category" => 8),
    55 => array("brand" => 63, "top_category" => 8),
    56 => array("brand" => 97, "top_category" => 8),
    57 => array("brand" => 95, "top_category" => 8),
    60 => array("brand" => 149, "top_category" => 10),
    61 => array("brand" => 107, "top_category" => 10),
    62 => array("brand" => 107, "top_category" => 9),
    64 => array("brand" => 99, "top_category" => 33),
    192 => array("brand" => 156),
    221 => array("brand" => 96, "top_category" => 33),
    66 => array("brand" => 105, "top_category" => 33),
    193 => array("brand" => 139, "top_category" => 33),
    67 => array("brand" => 160, "top_category" => 33),
    68 => array("brand" => 83, "top_category" => 33),
    70 => array("brand" => 119, "top_category" => 33),
    179 => array("brand" => 71, "top_category" => 10),
    180 => array("brand" => 96, "top_category" => 10),
    72 => array("brand" => null),
    73 => array("brand" => null),
    74 => array("brand" => null),
    210 => array("brand" => 116, "top_category" => 8),
    211 => array("brand" => 73, "top_category" => 33),
    79 => array("brand" => 105, "top_category" => 9),
    80 => array("brand" => 131, "top_category" => 10),
    136 => array("brand" => 72, "top_category" => 9),
    83 => array("brand" => 88, "top_category" => 9),
    84 => array("brand" => 107, "top_category" => 33),
    224 => array("brand" => 77, "top_category" => 9),
    258 => array("brand" => 120, "top_category" => 33),
    87 => array("brand" => 95, "top_category" => 10),
    273 => array("brand" => 65, "top_category" => 9),
    88 => array("brand" => 83, "top_category" => 10),
    160 => array("brand" => 157, "top_category" => 33),
    93 => array("brand" => 80, "top_category" => 9),
    256 => array("brand" => 153, "top_category" => 10),
    259 => array("brand" => 129, "top_category" => 33),
    261 => array("brand" => null),
    262 => array("brand" => null),
    263 => array("brand" => null),
    264 => array("brand" => null),
    94 => array("brand" => 76, "top_category" => 9),
    95 => array("brand" => 131, "top_category" => 33),
    96 => array("brand" => 135, "top_category" => 33),
    97 => array("brand" => 127, "top_category" => 33),
    183 => array("brand" => 95, "top_category" => 33),
    189 => array("brand" => 73, "top_category" => 10),
    218 => array("brand" => 111, "top_category" => 33),
    219 => array("brand" => 111, "top_category" => 8),
    220 => array("brand" => 102, "top_category" => 10),
    100 => array("brand" => 89, "top_category" => 9),
    178 => array("brand" => 96, "top_category" => 8),
    103 => array("brand" => 151, "top_category" => 10),
    104 => array("brand" => 121, "top_category" => 33),
    107 => array("brand" => 84, "top_category" => 9),
    108 => array("brand" => 84, "top_category" => 10),
    109 => array("brand" => 81, "top_category" => 9),
    112 => array("brand" => 117, "top_category" => 9),
    114 => array("brand" => 114, "top_category" => 9),
    116 => array("brand" => 68, "top_category" => 33),
    117 => array("brand" => 148, "top_category" => 10),
    223 => array("brand" => 150, "top_category" => 10),
    246 => array("brand" => 137, "top_category" => 33),
    257 => array("brand" => 75, "top_category" => 9),
    123 => array("brand" => 98, "top_category" => 10),
    128 => array("brand" => 83, "top_category" => 9),
    129 => array("brand" => 85, "top_category" => 10),
    195 => array("brand" => 128, "top_category" => 33),
    134 => array("brand" => 103, "top_category" => 10),
    265 => array("brand" => null),
    266 => array("brand" => 69, "top_category" => 9),
    275 => array("brand" => null),
    268 => array("brand" => 123, "top_category" => 33),
    269 => array("brand" => 129, "top_category" => 10),
    270 => array("brand" => 115, "top_category" => 9),
    271 => array("brand" => 115, "top_category" => 8),
    272 => array("brand" => 115, "top_category" => 10),
    274 => array("brand" => 94, "top_category" => 33),
    137 => array("brand" => 72, "top_category" => 10),
    139 => array("brand" => 152, "top_category" => 10),
    142 => array("brand" => 101, "top_category" => 33),
    143 => array("brand" => 103, "top_category" => 9),
    //144 => array("brand" => null, "top_category" => 8),
    146 => array("brand" => 87, "top_category" => 9),
    //149 => array("brand" => null, "top_category" => 33),
    152 => array("brand" => 80, "top_category" => 10),
    163 => array("brand" => null),
    151 => array("brand" => 147, "top_category" => 10),
    153 => array("brand" => 102, "top_category" => 8),
    154 => array("brand" => 117, "top_category" => 10),
    155 => array("brand" => 87, "top_category" => 10),
    156 => array("brand" => 102, "top_category" => 33),
    158 => array("brand" => 111, "top_category" => 10),
    209 => array("brand" => 79, "top_category" => 10),
    162 => array("brand" => 103, "top_category" => 33),
    164 => array("brand" => null),
    165 => array("brand" => 112, "top_category" => 8),
    207 => array("brand" => 138, "top_category" => 33),
    208 => array("brand" => 66, "top_category" => 9),
    168 => array("brand" => 112, "top_category" => 9),
    169 => array("brand" => 118, "top_category" => 33),
    170 => array("brand" => 157, "top_category" => 33),
    174 => array("brand" => 60, "top_category" => 8),
    175 => array("brand" => 60, "top_category" => 9),
    176 => array("brand" => 81, "top_category" => 10),
    177 => array("brand" => 102, "top_category" => 9),
    198 => array("brand" => null),
    199 => array("brand" => 94, "top_category" => 8),
    200 => array("brand" => 94, "top_category" => 10),
    201 => array("brand" => 94, "top_category" => 9),
    202 => array("brand" => 144, "top_category" => 10),
    213 => array("brand" => 76, "top_category" => 33),
    245 => array("brand" => 62, "top_category" => 33),
    217 => array("brand" => 68, "top_category" => 10),
    214 => array("brand" => null),
    215 => array("brand" => 68, "top_category" => 9),
    216 => array("brand" => 111, "top_category" => 9),
    226 => array("brand" => 85, "top_category" => 9),
    227 => array("brand" => 80, "top_category" => 33),
    228 => array("brand" => 70, "top_category" => 9),
    229 => array("brand" => 130, "top_category" => 33),
    230 => array("brand" => 146, "top_category" => 10),
    231 => array("brand" => 133, "top_category" => 33),
    233 => array("brand" => 117, "top_category" => 8),
    234 => array("brand" => 100, "top_category" => 33),
    235 => array("brand" => 100, "top_category" => 8),
    236 => array("brand" => 62, "top_category" => 8),
    276 => array("brand" => 64, "top_category" => 9),
    237 => array("brand" => 62, "top_category" => 9),
    238 => array("brand" => 116, "top_category" => 9),
    244 => array("brand" => 86, "top_category" => 9),
    247 => array("brand" => 154),
    248 => array("brand" => 136, "top_category" => 33),
    249 => array("brand" => 140, "top_category" => 10),
    250 => array("brand" => 141, "top_category" => 10),
    241 => array("brand" => null),
    242 => array("brand" => null),
    243 => array("brand" => 89, "top_category" => 10),
    251 => array("brand" => 143, "top_category" => 10),
    252 => array("brand" => 125, "top_category" => 33),
    253 => array("brand" => 67, "top_category" => 9),
    254 => array("brand" => 74, "top_category" => 9),
    255 => array("brand" => 159, "top_category" => 33),
    277 => array("brand" => 115, "top_category" => 33),
    278 => array("brand" => 114, "top_category" => 8),
);

$_productTypeCategoryMap = array(
    1 => array(8 => 540, 9 => 528),
    2 => array(8 => 541, 9 => 529, 10 => 535),
    3 => array(8 => 542, 9 => 530, 10 => 536),
    4 => array(9 => 531, 10 => 537),
    5 => array(10 => 538),
    6 => array(8 => 543, 9 => 532),
    7 => array(9 => 533),
    8 => array(10 => 539),
    9 => array(33 => 544),
    10 => array(33 => 555),
    11 => array(33 => 545),
    12 => array(33 => 546),
    13 => array(33 => 547),
);

$_specialCategoryMap = array(
    194 => 553, // Accessories: Juicy Couture
    240 => 569, // Back To School: Shoes
    49  => 557, // Sale: Boys
    50  => 558, // Sale: Girls
    192 => 554, // Accessories: Ed Hardy
    72  => 549, // Accessories: Boys
    73  => 550, // Accessories: Girls
    74  => 548, // Accessories: Baby
    261 => 560, // Mid Season Sale: Girls
    262 => 559, // Mid Season Sale: Boys
    263 => 561, // Mid Season Sale: Baby
    264 => 562, // Mid Season Sale: Accessories
    265 => 563, // Mid Season Sale: Shoes
    275 => 564, // Sale: Accessories
    163 => 565, // Sale: Babies
    164 => 566, // Sale: Shoes
    198 => 337, // New In
    214 => 551, // Accessories: Barts
    247 => 552, // Accessories: Spirithoods
    241 => 567, // Back To School: Coats
    242 => 568, // Back To School: Accessories
);



function _mapDataToArray($columnsArray, $dataArray) {
    $finalArray = array();
    foreach ($columnsArray as $i => $key) {
        $finalArray[$key] = $dataArray[$i];
    }
    return $finalArray;
}

function getAttributeOptionValue($arg_attribute, $arg_value) {
    $attribute_model = Mage::getModel('eav/entity_attribute');
    $attribute_options_model= Mage::getModel('eav/entity_attribute_source_table');
    $attribute_code = $attribute_model->getIdByCode('catalog_product', $arg_attribute);
    $attribute = $attribute_model->load($attribute_code);
    $attribute_table = $attribute_options_model->setAttribute($attribute);
    $options = $attribute_options_model->getAllOptions(false);
    foreach($options as $option) {
        if ($option['label'] == $arg_value) {
            return $option['value'];
        }
    }
    return false;
}

function addAttributeOption($arg_attribute, $arg_value) {
    $attribute_model = Mage::getModel('eav/entity_attribute');
    $attribute_options_model= Mage::getModel('eav/entity_attribute_source_table');
    $attribute_code = $attribute_model->getIdByCode('catalog_product', $arg_attribute);
    $attribute = $attribute_model->load($attribute_code);
    $attribute_table = $attribute_options_model->setAttribute($attribute);
    $options = $attribute_options_model->getAllOptions(false);
    $value['option'] = array($arg_value,$arg_value);
    $result = array('value' => $value);
    $attribute->setData('option',$result);
    $attribute->save();
    return getAttributeOptionValue($arg_attribute, $arg_value);
}

function getProductUrlKey($productName) {
    $urlstr_base = Mage::getModel('catalog/product')->getUrlModel()->formatUrlKey($productName);
    $urlstr = $urlstr_base;
    $url_exists = true;
    $incr = 1;
    do {
        $p_tmp = Mage::getModel('catalog/product')->loadByAttribute("url_key", $urlstr);
        if (!$p_tmp) {
            $url_exists = false;
        }
        else {
            $urlstr = $urlstr_base . $incr;
            $incr++;
        }
    } while($url_exists == true);
    return $urlstr;    
}

function _addImagesToProduct(array $data, Mage_Catalog_Model_Product $main_product) {
    echo "Adding images\n";
    
    $xProduct = Mage::getModel('catalog/product')->load($main_product->getId());

    if ($data['image1'] != "") {
        echo "Adding image 1 (" . $data['image1'] . ")\n";
        $xProduct->addImageToMediaGallery(_fetchImageFromUrl($data['image1']), array("thumbnail", "small_image", "image"), false, false);
    }
    if ($data['image2'] != "") {
        echo "Adding image 2 (" . $data['image2'] . ")\n";
        $xProduct->addImageToMediaGallery(_fetchImageFromUrl($data['image2']), array(), false, false);
    }
    if ($data['image3'] != "") {
        echo "Adding image 3 (" . $data['image3'] . ")\n";
        $xProduct->addImageToMediaGallery(_fetchImageFromUrl($data['image3']), array(), false, false);
    }

    echo "Saving..\n";

    $xProduct->save();
}
function _fetchImageFromUrl($url) {
    $url = parse_url($url);
    $pi = pathinfo($url['path']);
    
    if (!is_dir(Mage::getBaseDir() . "/var/tmp")) {
        mkdir(Mage::getBaseDir() . "/var/tmp");
    }
    
    $filename = Mage::getBaseDir() . "/var/tmp/" . $pi['basename'];
    $finalUrl = $url['scheme'] . "://" . $url['host'] . $url['path'];
    
    if (!file_exists($filename)) {
        echo "Fetching image from " . $finalUrl . "\n";
        file_put_contents($filename, file_get_contents($finalUrl));
    }
    
    return $filename;
}




